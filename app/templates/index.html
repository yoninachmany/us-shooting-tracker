
<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>US firearm violence incidents</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
  <style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
  }

  #map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
  }

  h1 {
    font-size: 20px;
    line-height: 30px;
  }

  h2 {
    font-size: 14px;
    line-height: 20px;
    margin-bottom: 10px;
  }

  a {
    text-decoration: none;
    color: #FFB700;
  }

  #console {
    position: absolute;
    margin: 10px;
    width: 360px;
    background-color: white;
    padding: 10px 20px;
  }

  .session {
    margin-bottom: 20px;
  }

  .row {
    height: 12px;
    width: 100%;
  }

  .colors {
    background: linear-gradient(to right, #FFEDA0, #FED976, #FEB24C, #FD8D3C, #FC4E2A, #E31A1C, #BD0026, #800026);
    margin-bottom: 5px;
  }

  .label {
    width: 11%;
    display: inline-block;
    text-align: center;
  }

  .mapboxgl-popup {
    max-width: 400px;
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  }
  </style>
</head>

<body>
  <div id='map'></div>
  <div id='console'>
    <h1>Firearm violence incidents</h1>
    <p>Data: <a href='http://gun-violence.org/download/'>Firearm violence injuries and death</a> in USA</p>
    <div class='session'>
      <h2>Incidents</h2>
      <div class='row colors'>
      </div>
      <div class='row labels'>
        <div class='label'>0</div>
        <div class='label'>10</div>
        <div class='label'>20</div>
        <div class='label'>50</div>
        <div class='label'>100</div>
        <div class='label'>200</div>
        <div class='label'>500</div>
        <div class='label'>1000+</div>
      </div>
    </div>
    <div class='session'>
      <h2>Year: <label id='active-year'>2000</label></h2>
      <input id='year-slider' class='row' type='range' min='2000' max='2017' step='1' value='2000' />
    </div>
    <div class='session'>
      <h2>Month: <label id='active-month'>January</label></h2>
      <input id='month-slider' class='row' type='range' min='0' max='11' step='1' value='0' />
    </div>
    <div id='circumstances'>
      <div class='session'>
        <h2>Shooter-victim relationship</h2>
        <div class='row' id='relationship'>
          <input id='knewEachOther' type='checkbox' value='knewEachOther'>
          <label for='knewEachOther'>Knew each other</label>
          <input id='domesticViolence' type='checkbox' value='domesticViolence'>
          <label for='domesticViolence'>Domestic violence</label>
        </div>
      </div>
      <div class='session'>
        <h2>Firearm use</h2>
        <div class='row' id='use'>
          <input id='anotherCrime' type='checkbox' value='anotherCrime'>
          <label for='anotherCrime'>During another crime</label>
          <input id='selfDefense' type='checkbox' value='selfDefense'>
          <label for='selfDefense'>In self defense</label>
        </div>
      </div>
      <div class='session'>
        <h2>Substances involved</h2>
        <div class='row' id='substances'>
          <input id='alcohol' type='checkbox' value='alcohol'>
          <label for='alcohol'>Alcohol</label>
          <input id='drugs' type='checkbox' value='drugs'>
          <label for='drugs'>Drugs (other than alcohol)</label>
        </div>
      </div>
      <div class='session'>
        <h2>Shooting intention</h2>
        <div class='row' id='intention'>
          <input id='selfDirected' type='checkbox' value='selfDirected'>
          <label for='selfDirected'>Self-directed</label>
          <input id='suicideOrAttempt' type='checkbox' value='suicideOrAttempt'>
          <label for='suicideOrAttempt'>Suicide</label>
          <input id='unintentional' type='checkbox' value='unintentional'>
          <label for='unintentional'>Unintentional</label>
        </div>
      </div>
      <div class='session'>
        <h2>Police involvement</h2>
        <div class='row' id='police'>
          <input id='byOfficer' type='checkbox' value='byOfficer'>
          <label for='byOfficer'>By a police officer</label>
          <input id='atOfficer' type='checkbox' value='atOfficer'>
          <label for='atOfficer'>At a police officer</label>
        </div>
      </div>
      <div class='session'>
        <h2>Firearm ownership</h2>
        <div class='row' id='ownership'>
          <input id='stolen' type='checkbox' value='stolen'>
          <label for='stolen'>Stolen</label>
          <input id='familyOwned' type='checkbox' value='familyOwned'>
          <label for='familyOwned'>Owned by victim/victim's family</label>
        </div>
      </div>
    </div>
  </div>
  <script src='//d3js.org/d3.v3.min.js' charset='utf-8'></script>
  <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiZXhhbXBsZXMiLCJhIjoiY2lqbmpqazdlMDBsdnRva284cWd3bm11byJ9.V6Hg2oYJwMAxeoR9GEzkAA';
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-107.7938316, 38.9764531],
    zoom: 3.5
  });

  // Add zoom and rotation controls to the map.
  map.addControl(new mapboxgl.NavigationControl());

  var data = null;

  var year = null;
  var month = null;
  var circumstances = null;

  map.on('load', function() {
    // Add the source to query. In this example we're using
    // congressional district polygons uploaded as vector tiles
    // Source: ftp://ftp2.census.gov/geo/tiger/TIGER2017/CD/
    map.addSource('districts', {
      type: 'vector',
      url: 'mapbox://yoninachmany.cxcgq8gk'
    });

    map.addLayer({
      id: 'districts',
      type: 'fill',
      source: 'districts',
      'source-layer': 'tl_2017_us_cd115-ahrk3y',
      paint: {
          'fill-outline-color': 'rgba(0,0,0,0.5)',
          'fill-color': 'rgba(0,0,0,0.1)'
      }
    });

    d3.json('/static/shootings2500.geojson', function(err, data) {

      // Add a new source from our GeoJSON data and set the
      // 'cluster' option to true. GL-JS will add the point_count property to your source data.
      map.addSource('shootings', {
        type: 'geojson',
        // Point to GeoJSON data.
        data: filterBy(data, year, month, circumstances),
        cluster: true,
        clusterMaxZoom: 14, // Max zoom to cluster points on
        clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
      });

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'shootings',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': [
            'step',
            ['get', 'point_count'],
            '#FFEDA0',
            10,
            '#FED976',
            20,
            '#FEB24C',
            50,
            '#FD8D3C',
            100,
            '#FC4E2A',
            200,
            '#E31A1C',
            500,
            '#BD0026',
            1000,
            '#800026'
          ],
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,
            10,
            22.5,
            20,
            25,
            50,
            27.5,
            100,
            30,
            200,
            32.5,
            500,
            35,
            1000,
            37.5
          ],
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'shootings',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': '{point_count_abbreviated}',
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 12
        }
      });

      map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'shootings',
        filter: ['!has', 'point_count'],
        paint: {
          'circle-color': '#11b4da',
          'circle-radius': 4,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#fff'
        }
      });

      // update year filter when the year slider is dragged
      document.getElementById('year-slider').addEventListener('input', function(e) {
        year = parseInt(e.target.value);
        // update the map
        map.getSource('shootings').setData(filterBy(data, year, month, circumstances));

        // update text in the UI
        document.getElementById('active-year').innerText = year;
      });

      var months = [
        'January',
        'February',
        'March',
        'April',
        'May',
        'June',
        'July',
        'August',
        'September',
        'October',
        'November',
        'December'
      ];

      // update month filter when the month slider is dragged
      document.getElementById('month-slider').addEventListener('input', function(e) {
        month = parseInt(e.target.value);
        // update the map
        map.getSource('shootings').setData(filterBy(data, year, month, circumstances));

        // update text in the UI
        document.getElementById('active-month').innerText = months[month];
      });

      document.getElementById('circumstances').addEventListener('change', function(e) {
        var checkedBoxes = Array.from(document.querySelectorAll('input[type=checkbox]:checked'));
        circumstances = checkedBoxes.map(x => x.value);
        map.getSource('shootings').setData(filterBy(data, year, month, circumstances));
      });
    });
  });

  // When a click event occurs on a feature in the unclustered-point layer, open a popup at the
  // location of the feature, with description HTML from its properties.
  map.on('click', 'unclustered-point', function (e) {
    map.flyTo({center: e.features[0].geometry.coordinates});

    var coordinates = e.features[0].geometry.coordinates.slice();
    var articleUrl = e.features[0].properties.articleUrl;
    var articleTitle = e.features[0].properties.articleTitle;

    // Ensure that if the map is zoomed out such that multiple
    // copies of the feature are visible, the popup appears
    // over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }

    new mapboxgl.Popup()
      .setLngLat(coordinates)
      .setHTML(`<a href=${articleUrl} target="_blank">${articleTitle}</a>`)
      .addTo(map);
  });

  // Change the cursor to a pointer when the mouse is over the unclustered-point layer.
  map.on('mouseenter', 'unclustered-point', function () {
    map.getCanvas().style.cursor = 'pointer';
  });

  // Change it back to a pointer when it leaves.
  map.on('mouseleave', 'unclustered-point', function () {
    map.getCanvas().style.cursor = '';
  });

  function filterBy(data, year, month, circumstances) {
    var features = data.features;
    if (year) {
      features = features.filter(feature => new Date(feature.properties.date).getFullYear() === year);
    }
    if (month) {
      features = features.filter(feature => new Date(feature.properties.date).getMonth() === month);
    }
    if (circumstances) {
      features = features.filter(feature => {
        for (var i = 0; i < circumstances.length; i++) {
          if (feature.properties[circumstances[i]] !== "Yes") {
            return false;
          }
        }
        return true;
      });
    }
    var featureCollection = {"type": "FeatureCollection", "features": features};
    return featureCollection;
  }
  </script>
</body>

</html>
